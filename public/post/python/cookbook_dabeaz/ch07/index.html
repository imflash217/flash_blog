<!doctype html><html lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Ronalds Vilcins - http://localhost:1313/"><title>| Vinay Kumar</title>
<meta name=description content><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Writing functions using def is a cornerstone of all programs. In this tutorial we will look into some of the advance usage of functions viz.
closures callback-functions control-flow keyword-only arguments default-arguments annotations any-number-of-arguments (*args & **kwargs) etc. 7.1: Function with any number of arguments (*args, **kwargs) # ???+ danger &ldquo;Problem&rdquo; You want to write a function that accepts any number of arguments.
???+ done &ldquo;Solution&rdquo; :rotating_light: For a function that accepts any number of positional arguments use a * argument."><meta property="og:title" content><meta property="og:description" content="Writing functions using def is a cornerstone of all programs. In this tutorial we will look into some of the advance usage of functions viz.
closures callback-functions control-flow keyword-only arguments default-arguments annotations any-number-of-arguments (*args & **kwargs) etc. 7.1: Function with any number of arguments (*args, **kwargs) # ???+ danger &ldquo;Problem&rdquo; You want to write a function that accepts any number of arguments.
???+ done &ldquo;Solution&rdquo; :rotating_light: For a function that accepts any number of positional arguments use a * argument."><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/post/python/cookbook_dabeaz/ch07/"><meta property="article:section" content="post"><meta itemprop=name content><meta itemprop=description content="Writing functions using def is a cornerstone of all programs. In this tutorial we will look into some of the advance usage of functions viz.
closures callback-functions control-flow keyword-only arguments default-arguments annotations any-number-of-arguments (*args & **kwargs) etc. 7.1: Function with any number of arguments (*args, **kwargs) # ???+ danger &ldquo;Problem&rdquo; You want to write a function that accepts any number of arguments.
???+ done &ldquo;Solution&rdquo; :rotating_light: For a function that accepts any number of positional arguments use a * argument."><meta itemprop=wordCount content="2650"><meta itemprop=keywords content><link rel=canonical href=http://localhost:1313/post/python/cookbook_dabeaz/ch07/><link rel=dns-prefetch href=https://www.google-analytics.com><link href=https://www.google-analytics.com rel=preconnect crossorigin><link rel=alternate type=application/atom+xml title="Vinay Kumar" href=http://localhost:1313/atom.xml><link rel=alternate type=application/json title="Vinay Kumar" href=http://localhost:1313/feed.json><link rel="shortcut icon" type=image/png href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII="><style>*,:after,:before{box-sizing:border-box;padding:0}body{font:1rem/1.5 '-apple-system',BlinkMacSystemFont,avenir next,avenir,helvetica,helvetica neue,ubuntu,roboto,noto,segoe ui,arial,sans-serif;text-rendering:optimizeSpeed}.posts hr{margin-top:0;margin-bottom:0;margin-right:.5rem;margin-left:.5rem;height:1px;border:none;border-bottom:1px #353535;flex:1 0 1rem}main{max-width:70ch;padding:2ch;margin:auto}a,body{color:#353535}::selection,a:focus,a:hover{background-color:#353535;color:#fff}.meta{margin:0 0 2.5rem}.tags::before{content:"\2022";margin-left:1rem}code,pre{color:#353535;font-family:San Francisco Mono,Monaco,consolas,lucida console,dejavu sans mono,bitstream vera sans mono,monospace;font-size:normal;border:1px solid #353535;font-size:small}.highlight [class^=language-]{color:#fff}code{padding:.1rem;border:none}pre{padding:.5rem;overflow-x:auto}pre code{border:none}img{max-width:100%;border:1px solid #353535}hr{background:#353535;height:1px;border:0}ul{list-style-type:square}ul,ol{padding-left:1.2rem}header li,footer li{display:inline;text-transform:uppercase}header a,footer a{text-decoration:none}header ul,footer ul{justify-content:space-between;display:flex}[aria-current=page]{text-decoration:line-through}header,section,footer{padding:1rem 0}blockquote{border-left:5px solid #353535;padding-left:1rem}.posts ul,header ul,footer ul{list-style:none}.posts,header ul,footer ul{padding:0}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.7rem}.posts li a,.posts li div{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}.hash{opacity:.25;text-decoration:none}table{border-collapse:collapse;text-align:left;width:100%}table tr{background:#fff;border-bottom:1px solid}table th,table td{padding:10px 20px}</style><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"post","name":"","headline":"","alternativeHeadline":"","description":"Writing functions using def is a cornerstone of all programs. In this tutorial we will look into some of the advance usage of functions viz.\nclosures callback-functions control-flow keyword-only arguments default-arguments annotations any-number-of-arguments (*args \u0026amp; **kwargs) etc. 7.1: Function with any number of arguments (*args, **kwargs) # ???\u002b danger \u0026ldquo;Problem\u0026rdquo; You want to write a function that accepts any number of arguments.\n???\u002b done \u0026ldquo;Solution\u0026rdquo; :rotating_light: For a function that accepts any number of positional arguments use a * argument.","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/localhost:1313\/post\/python\/cookbook_dabeaz\/ch07\/"},"author":{"@type":"Person","name":""},"creator":{"@type":"Person","name":""},"accountablePerson":{"@type":"Person","name":""},"copyrightHolder":"Vinay Kumar","copyrightYear":"0001","dateCreated":"0001-01-01T00:00:00.00Z","datePublished":"0001-01-01T00:00:00.00Z","dateModified":"0001-01-01T00:00:00.00Z","publisher":{"@type":"Organization","name":"Vinay Kumar","url":"http://localhost:1313/","logo":{"@type":"ImageObject","url":"http:\/\/localhost:1313\/","width":"32","height":"32"}},"image":"http://localhost:1313/","url":"http:\/\/localhost:1313\/post\/python\/cookbook_dabeaz\/ch07\/","wordCount":"2650","genre":[],"keywords":[]}</script></head><body><main><header><nav><ul><li><a href=/>Index</a></li><li><a href=/about/>About</a></li><li><a href=/atom.xml>RSS</a></li></ul></nav></header><hr><section><span itemprop=articleBody><p>Writing functions using <code>def</code> is a cornerstone of all programs.
In this tutorial we will look into some of the advance usage of functions
viz.</p><ol><li>closures</li><li>callback-functions</li><li>control-flow</li><li>keyword-only arguments</li><li>default-arguments</li><li>annotations</li><li>any-number-of-arguments (<code>*args</code> & <code>**kwargs</code>) etc.</li></ol><h2 id=71-function-with-any-number-of-arguments-args-kwargs>7.1: Function with any number of arguments (<code>*args, **kwargs</code>) <a href=#71-function-with-any-number-of-arguments-args-kwargs class=hash>#</a></h2><p>???+ danger &ldquo;Problem&rdquo;
You want to write a function that accepts any number of arguments.</p><p>???+ done &ldquo;Solution&rdquo;
:rotating_light: For a function that accepts any number of <strong>positional</strong> arguments use a <strong><code>*</code></strong> argument.</p><pre><code>:rotating_light: For a function that accepts any number of **keyword** arguments use a `**` argument.

To write any function that accepts any numbe rof positional arguments, use a **`*`** argument as shown below.
In this example, **`rest`** is a **`tuple`** of all extra positional arguments passed.
In above code, it is treated as a **`sequence`** in further calculations inside the function.

```python hl_lines=&quot;1&quot;
def avg(first, *rest):
    return (first + sum(rest)) / (1 + len(rest))

## ------------------------------------------------- ##

avg(1, 2, 3)        ## return=2.0; first=1, rest=(2, 3)
avg(1, 2, 3, 4)     ## return=2.5; first=1, rest=(2, 3, 4)
```

To accept any number of **keyword arguments** use a `**` argument as shown below. 
In the below code, **`attrs`** is a **dictionary** that holds the passed keyword arguments (if any)

```python hl_lines=&quot;3&quot;
import html

def make_element(name, value, **attrs):
    keyvals = [f&quot;{key}='{val}'&quot; for key, val in atts.items]
    attr_str = &quot;&quot;.join(keyvals)
    element = f&quot;&lt;{name}{attr_str}&gt;{html.escape(value)}&lt;/{value}&gt;&quot;
    return element
```
```python
## Creates: &quot;&lt;item size='large' quantity=6&gt;Albatross&lt;/item&gt;&quot;
make_element(&quot;item&quot;, &quot;Albatross&quot;, size=&quot;large&quot;, quantity=6)
```
```python
## Creates: &quot;&lt;p&gt;&amp;lt;spam&amp;gt;&lt;/p&gt;&quot;
make_element(p, &quot;&lt;spam&gt;&quot;)
```

:trophy: If you want a function that accepts both any-number-of-positional-arguments aswell as
any-number-of-keyword-arguments use both **`*`** &amp; `**` arguments as shown below

```python hl_lines=&quot;1&quot;
def anyargs(*args, **kwargs):
    print(args)     ## a tuple
    print(kwargs)   ## a dictionary
```
</code></pre><p>???+ quote &ldquo;Discussion&rdquo;
:rotating_light: A <strong><code>*</code></strong> argument can only appear as the <strong>last positional argument</strong> in a function
and a <code>**</code> argumnet can only appear as the <strong>last argumnet</strong> in a function.</p><pre><code>:trophy: A subtle aspect of function definition is that arguments can still appear 
after a **`*`** argument by they are treated as keyword argument only (as discussed in further lessons).

```python
## valid function definitions
def a(x, *args, y): pass
def b(x, *args, y, **kwargs): pass


## WRONG function defintions
## here argument &quot;z&quot; appears after `**kwargs`; hence its a WRONG definition

def c(x, *args, **kwargs, z): pass

```
</code></pre><h2 id=72-keyword-only-arguments>7.2: Keyword-only arguments <a href=#72-keyword-only-arguments class=hash>#</a></h2><p>???+ danger &ldquo;Problem&rdquo;
You want to write a function that accepts <strong>only keyword arguments</strong>.</p><p>???+ done &ldquo;Solution&rdquo;
This feature is easy to implement if you place the <strong>keyword argument</strong> after the <strong><code>*</code></strong> argument
or <strong>a single unnamed <code>*</code></strong> as shown below.</p><pre><code>```python hl_lines=&quot;1 7&quot;
def recv(maxsize, *, block):
    &quot;&quot;&quot;Receives a message&quot;&quot;&quot;
    pass

##-------------------------------------##

recv(1024, True)            ## Type Error
recv(2024, block=True)      ## OK
```

This technique can also be used to specify keyword arguments for functions that
accept **varying numbe rof positional arguments** as shown below.

```python hl_lines=&quot;1&quot;
def minimum(*values, clip=None):
    m = min(values)
    if clip is not None:
        m = clip if clip &gt; m else m
    return m

## ----------------------------------------- ##

minimum(1, 2, 5, -5, 10)            ## -5
minimum(1, 2, 5, -5, 10, clip=0)    ## 0
```
</code></pre><p>???+ quote &ldquo;Discussion&rdquo;
:rotating_light: <strong>Keyword-only arguments</strong> are a good way to enforce greater code-clarity when
specifying optional function arguments. For example consider the following code:</p><pre><code>```python
msg = recv(1024, False)
```
If someone is not familiar with **`recv`** (written in above section), they might not know 
what does **`False`** mean in this scenario. On the other hand, its much clearer to the user 
if someone writes the call as below:

```python
msg = recv(1024, block=False)
```

:trophy: The use of keyword-only arguments is often very useful for tricks involving `**kwargs`,
since they show up nicely when the user asks for `help()`

```zsh
&gt;&gt;&gt; help(recv)
Help on function recv in module __main__:
recv(maxsize, *, block):
    &quot;&quot;&quot;Receives a message&quot;&quot;&quot;
```

:trophy: Keyword-only arguments also have utility in advance usage like **argument injection** 
using `*args` &amp; `**kwargs`.
</code></pre><h2 id=73-function-argument-annotations>7.3: Function argument annotations <a href=#73-function-argument-annotations class=hash>#</a></h2><p>???+ danger &ldquo;Problem&rdquo;
You&rsquo;ve written a function but you want add some additional information about the <strong>arguments</strong>
so that users can know more easily how a function is supposed to be used.</p><p>???+ done &ldquo;Solution&rdquo;
<strong>Function argument annotations</strong> can be very useful in givin gprogrammers hint about how a function is supposed to be used.
Cosider the following <strong>annotated</strong> function.</p><pre><code>```python
## normal function definition
def add(x, y):
    return x + y

## Annotated function definition -- MUCH BETTER for users
def add(x:int, y:int) -&gt; int:
    return x + y
```

:rotating_light: **The Python Interpreter does not add any semantic meaning to the attached annotations.**
Neither are they type-cheked nor does Puython behave any differently than before.
However, they might give useful hunts about types that would be useful for users or third-party libraries.

:trophy: Any type of object can be uased as an annotation (eg. numbers, string, instances, types, etc.).
</code></pre><p>???+ quote &ldquo;Discussion&rdquo;
Function annotations are merely stored in function&rsquo;s <strong><code>__annotations__</code></strong> attribute.</p><pre><code>```ipython hl_lines=&quot;1&quot;
&gt;&gt;&gt; add.__annotations__
{&quot;y&quot;: &lt;class &quot;int&quot;&gt;,
 &quot;return&quot;: &lt;class &quot;int&quot;&gt;,
 &quot;x&quot;: &lt;class &quot;int&quot;&gt;,
}
```

Although, annotations have many potential use-cases, their primary utility is probably **just documentation**.
Because Python does not have type decalrations, it can be difficult to read a source code without much documentation
and hind about the types of objects; **function annotations** are one way to resolve this problem.

:rotating_light: More advance usage of function annotations is to implement **multiple dispatch** (i.e. _overloaded functions_)
</code></pre><h2 id=77-capturing-variables-in-anonymous-functions>7.7: Capturing variables in Anonymous functions <a href=#77-capturing-variables-in-anonymous-functions class=hash>#</a></h2><p>???+ danger &ldquo;Problem&rdquo;
You have defined an anonymous function using <strong><code>lambda</code></strong> and but you also need to capture the
value of certain variable at the tim eof definition.</p><p>???+ done &ldquo;Solution&rdquo;
Consider the behaviour of the following code a python console:</p><pre><code>```ipython
&gt;&gt;&gt; x = 10
&gt;&gt;&gt; a = lambda y: x + y
&gt;&gt;&gt;
&gt;&gt;&gt; x = 20
&gt;&gt;&gt; b = lambda y: x + y
```

Now ask yourself a question. What is the value of **`a(10)`** and **`b(10)`** now?
If you think that the values will be `20` and `30`; you would be wrong.
The python console gives the follwoing results.

```ipython
&gt;&gt;&gt; a(10)
30
&gt;&gt;&gt;
&gt;&gt;&gt; b(10)
30
```

:trophy: The problem here is that **`x`** used here (in the **`lambda`** expression) is a **free variable**;
**that gets bound at _runtime_, not at _definition time_.** The value **`x`** in the `lambda` expression is
whatever the value of **`x`** variable happens to be at the time of execution of the statement **`a(10), b(10)`**.
For example see below code:

```ipython
&gt;&gt;&gt; x=15
&gt;&gt;&gt; a(10)
25
&gt;&gt;&gt;
&gt;&gt;&gt; x=3
&gt;&gt;&gt; a(10)
13
```

:rotating_light: If you want an anonymous `lambda` function to capture a value at the **point of definition**
include that value as a **default value** in the `lambda` expression definition as follows.

```ipython hl_lines=&quot;2 5&quot;
&gt;&gt;&gt; x = 10
&gt;&gt;&gt; a = lambda y, x=x: x + y
&gt;&gt;&gt;
&gt;&gt;&gt; x = 20
&gt;&gt;&gt; b = lambda y, x=x: x + y
&gt;&gt;&gt;
&gt;&gt;&gt; a(10)
20                          ## Note the difference here from above code (earlier this was 30)
&gt;&gt;&gt;
&gt;&gt;&gt; b(10)
30                          ## Note that &quot;b&quot; captured the correct value of &quot;x&quot;
```
</code></pre><p>???+ quote &ldquo;Discussion&rdquo;
The problem addressed here comes up very often in code that tries to be a just a bit more clever.
For example, creating a list of <code>lambda</code> expressions using a <code>list comprehension</code> or a loop of some kind
<strong>and expecting the <code>lambda</code> expressions to remember the iteration variable at the time of defintion</strong>.
For example:</p><pre><code>```python hl_lines=&quot;5-9&quot;
&gt;&gt;&gt; funcs = [lambda x: x+n for n in range(5)]
&gt;&gt;&gt; for f in funcs:
...     print(f(0))
...
4
4
4
4
4
&gt;&gt;&gt;
```

Notice, how all `lambda` expressions take the same final value of `n` from the `range(5)` expression.

:rotating_light: But, if we specifically captuer the value of `n` using **default arguments**, 
then we get the behaviour we want

```python hl_lines=&quot;1&quot;
&gt;&gt;&gt; funcs = [lambda x, n=n: x + n for n in range(5)]
&gt;&gt;&gt; for f in funcs:
...     print(f(0))
...
0
1
2
3
4
&gt;&gt;&gt;
```
</code></pre><h2 id=78-functoolspartial>7.8: functools.partial() <a href=#78-functoolspartial class=hash>#</a></h2><p>???+ danger &ldquo;Making an N-argumnet callable work asa callable with fewwer argumnets&rdquo;
You have a callable that you want to make it work with other Python code.
possbly as a callabel or <strong>handler</strong>, but it takes too many argumnets and causes
an exception when called.</p><p>???+ done &ldquo;Solution&rdquo;
If you need to reduce the number of arguments to a function, you should use <strong><code>functools.partial()</code></strong>
The <strong><code>partial()</code></strong> function allows you to assign fixed values to one or more of the arguments
thus reduce the number of required argumnets in <strong>subsequent calls of the reduced function</strong>. as shown below.</p><pre><code>```python
def spam(a, b, c, d):
    print(a, b, c, d)
```
Now consider **`functools.partial()`** to fix certain arguments.

```ipython
&gt;&gt;&gt; from functools import partial
&gt;&gt;&gt; 
&gt;&gt;&gt; s1 = partial(spam, 1)               ## a=1
&gt;&gt;&gt; s1(2,3,4)                           ## note that it takes only 3 arguments
1 2 3 4
```
```ipython
&gt;&gt;&gt; s2 = partial(spam, d=42)            ## d=42
&gt;&gt;&gt; s2(1,2,3)
1 2 3 42
&gt;&gt;&gt; s2(5, 99, 32)
5 99 32 42
```
```ipython
&gt;&gt;&gt; s3 = partial(spam, 1, 2, d=42)      ## a=1, b=2, d=42
&gt;&gt;&gt; s3(99)
1 2 99 42
&gt;&gt;&gt;
```
</code></pre><p>???+ quote &ldquo;Discussion&rdquo;
&mldr;</p><h2 id=79-replacing-single-method-classes-with-functions>7.9: Replacing single method classes with functions <a href=#79-replacing-single-method-classes-with-functions class=hash>#</a></h2><p>???+ danger &ldquo;Problem&rdquo;
You have a class that only defines a single method except <code>__init__()</code> method.
However, to simplify your code, you would much rather have a simple function.</p><p>???+ done &ldquo;Solution&rdquo;
:rotating_light: In many cases, single method classes can be turned into functions using <strong><code>closures</code></strong>.</p><pre><code>Consider the following example, which allws users to fetch `URLs` using a kind of **template-scheme**.

```python hl_lines=&quot;14-16&quot;
from urllib.request import urlopen

class UrlTemplate:
    def __init__(self, template):
        self.template = template
    def open(self, **kwargs):
        return urlopen(self.template.format_map(kwargs))

## -------------------------------------------------------------------------------- ##

## Usage of above class
## Example Use: Download stock data from yahoo

yahoo = UrlTemplate(&quot;http://finance.yahoo.com/d/quotes.csv?s={names}&amp;f={fields}&quot;)
for line in yahoo.open(names=&quot;APPL, FB, TSLA&quot;, fields=&quot;sl1c1v&quot;):
    print(line.decode(&quot;utf-8&quot;))
```

This **`URLTemplate`** class be very easily replaced with a much simpler function using **closures**.
as shown below.

```python hl_lines=&quot;13-15&quot;
## Using closures
from urllib.request import urlopen

def url_template(template):
    def opener(**kwargs):
        return urlopen(template.format_map(kwargs))
    return opener

## ------------------------------------------------------------------------------- ##

## Example Usage of the above CLOSURE &quot;url_template&quot;

yahoo = url_template(&quot;http://finance.yahoo.com/d/quotes.csv?s={names}&amp;f={fields}&quot;)
for line in yahoo(names=&quot;APPL, FB, TSLA&quot;, fileds=&quot;sl1c1v&quot;):
    print(line.decode(&quot;utf-8&quot;))
```
</code></pre><h2 id=710-carrying-extra-state-with-callback-functions>7.10: Carrying extra state with callback functions <a href=#710-carrying-extra-state-with-callback-functions class=hash>#</a></h2><p>???+ danger &ldquo;Problem&rdquo;
You are writing code that relies on the use of <strong>callback functions</strong>
(e.g. <em>event handlers</em>, <em>completion callback</em>, etc.); but you want to have the
callback function carry extra state to be used inside the callback function itself.</p><p>???+ done &ldquo;Solution&rdquo;
Let&rsquo;s first talk about <strong>callback functions</strong> which are used in <em>asynchronous processing</em>
via the following example:</p><pre><code>```python hl_lines=&quot;6&quot;
def apply_async(func, args, *, callback):
    ## compute the result
    result = func(*args)

    ## invoke the callback
    callback(result)
```

In reality, such code might do all sorts of advanced processing involving threads, processes,
&amp; timers. But here we are just focusing on the **invocation** of the **callback**.
Below, we show how to use the above code:

```python
def print_result(result):
    print(f&quot;Got: {result}&quot;)

def add(x, y):
    return x + y
```

```ipython
&gt;&gt;&gt; apply_async(add, (2, 3), callback=print_result)
Got: 5
&gt;&gt;&gt; apply_result(add, ('Hello&quot;, &quot;World'), callback=print_result)
Got: &quot;HelloWorld&quot;
```

As you can notice above, the callbakc function **`print_result()`** only accepts a **single argument**
i.e **`result`**. No other information is provided.
This lack of information can be an issue when we want our callback function to interact with other contextual variables
or other parts of the code.
Below we provide some probable solutions to handle this issue:

:rotating_light: Some ways to carry extra information with callbacks:

1. Use **bound methods** instead of regular sinple functions.
2. Use **closures**
3. Use **coroutines**.
4. Using **`functools.partial()`**

:trophy: Using **BOUND METHODS**: One way to carry extra information in a callback is to use **bound methods** 
instead of simple function. For example, this below class keeps an internal sequence number 
that is incremented everytime a result is received.

```python
class ResultHandler:
    def __init__(self):
        self.sequence = 0
    def handler(self, result):
        self.sequence += 1
        print(f&quot;[{self.sequence}] Got: {result}&quot;)
```
To use this class **`ResultHandler`**, we need to create its instance and use its 
**`handler()`** method as a callback.

```ipython hl_lines=&quot;3 5&quot;
&gt;&gt;&gt; rh = ResultHandler()                 ## creating an instance of the class
&gt;&gt;&gt; apply_async(add, (2, 3), callback=rh.handler)
[1] Got: 5
&gt;&gt;&gt; apply_async(add, (&quot;Hello&quot;, &quot;World&quot;), callback=rh.handler)
[2] Got: &quot;HelloWorld&quot;
```
Notice in the above output, how the instance of `ResultHandler` class **`rh`** uses its internal state variable
**`self.sequence`** across two different calls of the callback function **`rh.handler`**.

------------------

:trophy: Using **CLOSURES**: As an alternative we can also use **closures** to embed additional information
in the callback function.

```python hl_lines=&quot;4&quot;
def make_handler():
    sequence = 0
    def handler(result):
        nonlocal sequence
        sequence += 1
        print(f&quot;[{sequence}] Got: {result}&quot;)
    return handler
```

```ipython hl_lines=&quot;1&quot;
&gt;&gt;&gt; handler = make_handler()                    ## our callback function to be used
&gt;&gt;&gt; apply_async(add, (2,3), callback=handler)
[1] Got: 5
&gt;&gt;&gt; apply_async(add, (&quot;Hello&quot;, &quot;World&quot;), callback=handler)
[2] Got: &quot;HelloWorld&quot;                                       ## the callback remembers the count sequence
```

-------------------

:trophy: Using **COROUTINES**: Sometimes we can also use a **coroutine** to accomplish what we achieved
using a **bound method** or a **closure**.

```python hl_lines=&quot;6&quot;
## Using COROUTINES to add context to a callback function

def make_handler():
    sequence = 0
    while True:
        result = yield
        sequence += 1
        print(f&quot;[{sequence}] Got: {result}&quot;)
```
We can use it as usual as before.

```ipython hl_lines=&quot;2 4&quot;
&gt;&gt;&gt; handler = make_handler()                            ## our callback function
&gt;&gt;&gt; apply_async(add, (2, 3), callback=handler.send)     
[1] Got: 5
&gt;&gt;&gt; apply_async(add, (&quot;Hello&quot;, &quot;WORLD!!&quot;), callback=handler.send)
[2] Got: &quot;HelloWORLD!!&quot;
```

:rotating_light: NOTICE the use of **`send`** to push value to the **`yield`** in the callback coroutine

----------------------------------

:trophy: Using **`functools.partial()`**: As an alternative, we can also carry state into a callback
using an extra argument and a **partial** function application.

```python
class SeqeunceNo:
    def __init__(self):
        self.sequence = 0

def handler(result, seq):
    seq.sequence += 1
    print(f&quot;[{seq.sequence}] Got: {result}&quot;)
```

```ipython hl_lines=&quot;1 2&quot;
&gt;&gt;&gt; from functools import partial
&gt;&gt;&gt; seq = SequenceNo()
&gt;&gt;&gt; apply_async(add, (2,3), callback=partial(handler, seq=seq))
[1] Got: 5
&gt;&gt;&gt; apply_async(add, (&quot;HELLO_&quot;, &quot;WORLD!!!&quot;), callback=partial(handler, seq=seq))
[2] Got: &quot;HELLO_WORLD!!!&quot;
```

---------------------------

:rotating_light: Because, **`lambda`** expressions can be very useful in creating **partial** functions.
We can use `lambda` expressions (with added contextual argumnets) as callbacks as shown below.

```ipython
&gt;&gt;&gt; seq = SequenceNo()
&gt;&gt;&gt; apply_async(add, (2,3), callback=lambda r: handler(r, seq))
[1] Got: 5
```
</code></pre><p>???+ quote &ldquo;Discussion&rdquo;
:rotating_light: Software based on <strong>callback functions</strong> often runs the risk of turning into a huge
tangled mess.</p><pre><code>Part of the reason is that **callback function is often disconnected from the code
that made the initial request leading up the callback execution&quot;. Thus the execution environment
between making the request and handling the result is effectively lost.** 

If you want the callback function to continue with a procedure involving multiple steps, 
you have to figure out how to save and restore the associated states.

There are really two main promising ways to capture and restore context states:

1. You can carry it around in a **class instance**. Attach it to **bound method** perhaps.
2. Or you can carry it around in a **closure** (an inner function).

Of the above two techniques, probably the **closures** approach is more natural and lightweight
in that they are built from functions. They also automatically captures all the variables used.

:warning: But, if using **closures**, we need to pay careful attention to _mutable_ variables.
In the above solution we use **`nonlocal`** declaration for variable **`sequence`** to specify that
we were using the variable from withing the closure; otherwise we will get an `ERROR`.

---------------------------

The use of **`coroutines`** is interesting and very closely resembles the usage of **closures**.

:trophy: In some sense, it is even cleaner as we don't have to worry about the `nonlocal` declarations.

:warning: Only potential downsides of using **coroutines** is that its somewhat difficult to understand 
conceptually and we have to remembr some nitty-gritty details of its usage 
(for example, making sure to call **`next()`** before using the couroutine as a callback etc...)

:rotating_light: Nevertheless, coroutines are very useful in defining **inlined callbacks**.
</code></pre></span></section><hr><footer><nav><ul><li>© 2025</li></ul></nav></footer></main></body></html>